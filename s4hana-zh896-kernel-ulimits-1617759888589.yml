---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# s4hana-zh896-kernel-ulimits
# https://cloud.redhat.com/insights/remediations/64dd0e6d-930a-4474-a169-be0c16b7832f
# Generated by Red Hat Insights on Wed, 07 Apr 2021 01:44:48 GMT
# Created by rhn-gps-smikkili

- name: run insights to obtain latest diagnosis info
  hosts: "s4hana-zh896.example.com"
  vars:
    insights_remediation: " 64dd0e6d-930a-4474-a169-be0c16b7832f"
    insights_signature_exclude: "/hosts,/vars/insights_remediation"
  become: True
  tasks:
    - name: obtain diagnosis info
      command: "insights-client --diagnosis{{ insights_remediation | regex_search('\\s[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}') }}"
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# SAP application will fail to run or its performance will degrade when resource limits do not meet SAP requirements
# Identifier: (advisor:sap_limits|SAP_LIMITS_ISSUE_V1,fix)
# Version: c38a356fba060a01c5d999fdaa2298dfe9a9e386
- name: Update resource limits to meet SAP requirment and reboot manually
  hosts: "s4hana-zh896.example.com"
  become: true
  vars:
    pydata: "{{ insights_report.details['sap_limits|SAP_LIMITS_ISSUE_V1'] | default('') }}"

  tasks:
    - name: Make sure the required files exists
      file:
        path: "{{ item.key }}"
        state: touch
      with_dict:
        - "{{ pydata.recommended }}"
      when: pydata.recommended is defined and pydata.playbooks is defined

    - name: Modify resource limits one by one
      lineinfile:
        path: "{{ item[0] }}"
        state: present
        regexp: '\s*{{ item[1] }}\s*{{ item[2] }}\s*{{ item[3] }}\s*'
        line : "{{ item[1] }} {{ item[2] }} {{ item[3] }} {{ item[4] }}"
        backup: yes
      with_items:
        - "{{ pydata.playbooks }}"
      when: pydata.playbooks is defined


- name: run insights
  hosts: "s4hana-zh896.example.com"
  vars:
    insights_signature_exclude: "/hosts"
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false